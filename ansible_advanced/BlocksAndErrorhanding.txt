Blocks

---
- hosts: server1
  tasks:
    - block:
        - name: Install mysql
          yum:
            name: mysql-server
            state: present
        -  name: start mysql service
           service:
             name: mysql-server
             state: started
      become_user: db-become_user
      when: ansible_facts['distribution'] == 'CentOS'
      rescue:
        - mail:
            to: admin@company.com
            subject: Installation failed
            body: DB install failed at {{ansible_failed_task.name}}

      always:
        - mail:
            to: admin@company.com
            subject: Iinstallation status
            body: DB install status - {{ansible_failed_result}}
-------------------------------------------------------------------

     We have three web nodes that are managed by Ansible. There is an inventory file ~/playbooks/inventory on Ansible controller which has all these three nodes added. Create a playbook ~/playbooks/blocks.yml on Ansible controller to install httpd web server and start its service. We need the tasks to be run only on CentOS based web nodes.

     Create the playbook using blocks to logically group the tasks (installation and service start) so that even if we run playbook for all hosts that are in inventory, the tasks are run only on CentOS based nodes.

     ---
- hosts: all
  tasks:
    - block:
        - name: Install httpd
          yum:
            name: httpd
            state: present

        -  name: start httpd service
           service:
             name: httpd
             state: started
      become: yes
      when: ansible_facts['distribution'] == 'CentOS
-----------------
---
- hosts: all
  tasks:
    - block:
        - name: Install httpd
          yum:
            name: httpd
            state: present

        -  name: start httpd service
           service:
             name: httpd
             state: started
      become: yes
      when: ansible_facts['distribution'] == 'CentOS'

      rescue:
        - debug:
            msg: "Playbook has failed for {{inventory_hostname}}"
----------------------------------------------
We just created a new playbook at ~/playbooks/blocks_always.yml. 
This playbook creates a file on all web nodes and performs some tasks on them. 
The last task that prints This task always runs! must always run.
 However, the playbook fails at the second task and as a result the third and fourth task does not run. We do not need to fix the second task for now, but by using always section we want the last task to always run regardless of status of other tasks before it.
Add an always section and configure the last task to always run. Do not modify any other task.
---
- hosts: all
  tasks:
    - name: Create a file
      block:
        - file:
            path: /tmp/file.txt
            state: touch

        - name: This will fail
          command: /bin/false

        - debug:
            msg: "This will never run"

      always:
        - debug:
            msg: "This task always runs!"
----------------------------
Error Handling